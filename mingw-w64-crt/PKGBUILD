# Maintainer: Nuclearist <nuclearist@teknology-hub.com>
# Upstream maintainer: Alexey Pavlov <alexpux@gmail.com>

_realname="crt"
pkgbase="mingw-w64-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgdesc="MinGW-w64 CRT for Windows (mingw-w64)"
pkgver=13.0.0.r453.gfd36ef357
pkgrel=1
_commit="fd36ef357f4964ad84628b2c69c15791b2f1f559"
arch=("x86_64")
mingw_arch=('tek-x86_64')
url="https://www.mingw-w64.org/"
msys2_repository_url="https://sourceforge.net/p/mingw-w64/mingw-w64/ci/master/tree/mingw-w64-crt/"
license=("spdx:ZPL-2.1")
groups=("${MINGW_PACKAGE_PREFIX}-toolchain")
depends=("${MINGW_PACKAGE_PREFIX}-headers")
makedepends=(
  "git"
  "${MINGW_PACKAGE_PREFIX}-binutils"
  "${MINGW_PACKAGE_PREFIX}-cc"
)
options=(
  "!strip"
  "!buildflags"
  "!emptydirs"
)
source=("mingw-w64"::"git+https://git.code.sf.net/p/mingw-w64/mingw-w64#commit=${_commit}")
sha256sums=("eaa8e8a79667560584e66df2aac8ad582b53fb6b342740b3edd7b7afddbc6f07")

pkgver() {
  cd "${srcdir}/mingw-w64"
  git describe --long "${_commit}" | sed 's/\([^-]*-g\)/r\1/;s/-/./g;s/^v//g'
}

build() {
  mkdir "${srcdir}/build-${MSYSTEM}" && cd "${srcdir}/build-${MSYSTEM}"
  "${srcdir}/mingw-w64/mingw-w64-crt/configure" \
    --prefix="${MINGW_PREFIX}" \
    --disable-dependency-tracking \
    --disable-lib32 --enable-lib64 \
    --with-default-msvcrt=ucrt
  make -j$(nproc)
}

package() {
  cd "${srcdir}/build-${MSYSTEM}"
  make DESTDIR="${pkgdir}" install-strip
  "${MINGW_PREFIX}/bin/ar" rcs "${pkgdir}${MINGW_PREFIX}/lib/libssp.a"
  "${MINGW_PREFIX}/bin/ar" rcs "${pkgdir}${MINGW_PREFIX}/lib/libssp_nonshared.a"
}
