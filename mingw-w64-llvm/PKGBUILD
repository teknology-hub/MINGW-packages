# Maintainer: Nuclearist <nuclearist@teknology-hub.com>
# Upstream maintainer: Martell Malone <martellmalone@gmail.com>
# Upstream maintainer: Alexey Pavlov <alexpux@gmail.com>
# Upstream contributor: Ray Donnelly <mingw.android@gmail.com>
# Upstream contributor: Mateusz Miku≈Ça <mati865@gmail.com>
# Upstream contributor: wirx6 <wirx654@gmail.com>
# Upstream contributor: Yuui Tanabe <yuuitanabe@163.com>
# Upstream contributor: Oscar Fuentes <ofv@wanadoo.es>
# Upstream contributor: Adrian Pop <adrian.pop@liu.se>

_realname="llvm"
pkgbase="mingw-w64-${_realname}"
pkgname=(
  "${MINGW_PACKAGE_PREFIX}-clang"
  "${MINGW_PACKAGE_PREFIX}-clang-libs"
  "${MINGW_PACKAGE_PREFIX}-clang-analyzer"
  "${MINGW_PACKAGE_PREFIX}-clang-tools-extra"
  "${MINGW_PACKAGE_PREFIX}-compiler-rt"
  "${MINGW_PACKAGE_PREFIX}-lld"
  "${MINGW_PACKAGE_PREFIX}-llvm"
  "${MINGW_PACKAGE_PREFIX}-llvm-tools"
  "${MINGW_PACKAGE_PREFIX}-llvm-libs"
)
pkgdesc="C language family frontend for LLVM (mingw-w64)"
pkgver=21.1.8
pkgrel=1
arch=("x86_64")
mingw_arch=("tek-x86_64")
url="https://llvm.org/"
msys2_references=("cpe: cpe:/a:llvm:llvm")
msys2_repository_url="https://github.com/llvm/llvm-project"
license=("spdx:Apache-2.0 WITH LLVM-exception")
makedepends=(
  "${MINGW_PACKAGE_PREFIX}-cc"
  "${MINGW_PACKAGE_PREFIX}-cmake"
  "${MINGW_PACKAGE_PREFIX}-compiler-rt"
  "${MINGW_PACKAGE_PREFIX}-libc++"
  "${MINGW_PACKAGE_PREFIX}-libffi"
  "${MINGW_PACKAGE_PREFIX}-libunwind"
  "${MINGW_PACKAGE_PREFIX}-llvm-tools"
  "${MINGW_PACKAGE_PREFIX}-pkgconf"
  "${MINGW_PACKAGE_PREFIX}-python"
)
_url="https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver}"
source=(
  "${_url}/clang-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/clang-tools-extra-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/cmake-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/compiler-rt-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/lld-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/llvm-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/runtimes-${pkgver}.src.tar.xz"{,.sig}
  "${_url}/third-party-${pkgver}.src.tar.xz"{,.sig}
  "0001-Fix-GetHostTriple-for-mingw-w64-in-msys.patch"
  "0002-Fix-Findzstd-on-MINGW.patch"
  "0303-ignore-new-bfd-options.patch"
)
sha256sums=(
  "6090e3f23720d003cdd84483a47d0eec6d01adbb5e0c714ac0c8b58de546aa62"
  "SKIP"
  "6ddb7e731bf09ab821132e2e8a3c706b6d9c52c92a9ce9a9ed0976a9c6c28829"
  "SKIP"
  "85735f20fd8c81ecb0a09abb0c267018475420e93b65050cc5b7634eab744de9"
  "SKIP"
  "dd54ae21aee1780fac59445b51ebff601ad016b31ac3a7de3b21126fd3ccb229"
  "SKIP"
  "d9524c5ee952500a2af92c27042a0d90ab089962af47816d4c85d0ebf76373d1"
  "SKIP"
  "d9022ddadb40a15015f6b27e6549a7144704ded8828ba036ffe4b8165707de21"
  "SKIP"
  "b6989d35cdfc1acee4af1d110fb8887f76831eb93e1df6ff7365004048742db8"
  "SKIP"
  "7fe99424384aea529ffaeec9cc9dfb8b451fd1852c03fc109e426fe208a1f1a7"
  "SKIP"
  "eb03df53671df6627768141b3aaa76abe176a14e5e47911c97bec544387c4aff"
  "d77d47e37e4948f5c01ae8bc05fb4e879b6516132c5a60c7bc820c9cbbb39668"
  "fd0253879cc5e31857f57307e6105e56493358e35d7c4540e0b476be607ab94e"
)
validpgpkeys=(
  "B6C8F98282B944E3B0D5C2530FC3042E345AD05D" # Hans Wennborg, Google.
  "474E22316ABF4785A88C6E8EA2C794A986419D8A" # Tom Stellard
  "71046D1E9C6656BDD61171873E83BABF4A4F9E85" # Cullen Rhodes
  "FFB3368980F3E6BB5737145A316C56D064CACBA5" # Douglas Yung
  "D574BD5D1D0E98895E3BF90044F2485E45D59042" # Tobias Hieta
)
noextract=(
  "clang-${pkgver}.src.tar.xz"
  "llvm-${pkgver}.src.tar.xz"
)

prepare() {
  tar -xf "${srcdir}"/clang-${pkgver}.src.tar.xz -C "${srcdir}" || true
  tar -xf "${srcdir}"/llvm-${pkgver}.src.tar.xz -C "${srcdir}" || true
  for pkg in clang clang-tools-extra cmake compiler-rt lld llvm runtimes third-party; do
    mv "${srcdir}/${pkg}-${pkgver}.src" "${srcdir}/${pkg}"
  done
  cd "${srcdir}/llvm"
  patch -Np1 -i "${srcdir}/0001-Fix-GetHostTriple-for-mingw-w64-in-msys.patch"
  patch -Np1 -i "${srcdir}/0002-Fix-Findzstd-on-MINGW.patch"
  cd "${srcdir}/lld"
  patch -Np1 -i "${srcdir}/0303-ignore-new-bfd-options.patch"
}

build() {
  FFI_INCLUDE_DIR="$("${MINGW_PREFIX}/bin/pkgconf" --cflags --keep-system-cflags libffi)"
  FFI_INCLUDE_DIR=$(echo $FFI_INCLUDE_DIR | sed 's|-I||g')
  local _common_config=(
    -DCMAKE_BUILD_TYPE=Release
    -DCMAKE_INSTALL_PREFIX="${MINGW_PREFIX}"
    -DCMAKE_SYSTEM_IGNORE_PATH=/usr/lib
    -DPython3_EXECUTABLE="${MINGW_PREFIX}/bin/python"
    -DCLANG_DEFAULT_CXX_STDLIB=libc++
    -DCLANG_DEFAULT_LINKER=lld
    -DCLANG_DEFAULT_RTLIB=compiler-rt
    -DCLANG_DEFAULT_UNWINDLIB=libunwind
    -DCOMPILER_RT_BUILD_SANITIZERS=OFF
    -DFFI_INCLUDE_DIR="${FFI_INCLUDE_DIR}"
    -DLLVM_BUILD_LLVM_DYLIB=ON
    -DLLVM_BUILD_STATIC=OFF
    -DLLVM_ENABLE_ASSERTIONS=OFF
    -DLLVM_ENABLE_FFI=ON
    -DLLVM_ENABLE_LTO=Thin
    -DLLVM_ENABLE_THREADS=ON
    -DLLVM_HOST_TRIPLE="${CARCH}-w64-windows-gnu"
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DLLVM_INCLUDE_EXAMPLES=OFF
    -DLLVM_INCLUDE_TESTS=OFF
    -DLLVM_LINK_LLVM_DYLIB=ON
  )
  "${MINGW_PREFIX}/bin/cmake" \
    -DCOMPILER_RT_BUILD_PROFILE=OFF \
    -DDEFAULT_SYSROOT="${MINGW_PREFIX}" \
    -DLLVM_BUILD_INSTRUMENTED=IR \
    -DLLVM_ENABLE_PROJECTS="clang" \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt" \
    -DLLVM_TARGETS_TO_BUILD=Native \
    "${_common_config[@]}" \
    -S "${srcdir}/llvm" \
    -B "${srcdir}/build-${MSYSTEM}-instrument"
  "${MINGW_PREFIX}/bin/cmake" --build "${srcdir}/build-${MSYSTEM}-instrument" --target compiler-rt --target clang
  "${MINGW_PREFIX}/bin/cmake" \
    -DCMAKE_C_COMPILER="${srcdir}/build-${MSYSTEM}-instrument/bin/clang.exe" \
    -DCMAKE_CXX_COMPILER="${srcdir}/build-${MSYSTEM}-instrument/bin/clang++.exe" \
    -DLLVM_ENABLE_PROJECTS="clang" \
    -DLLVM_TARGETS_TO_BUILD=Native \
    "${_common_config[@]}" \
    -S "${srcdir}/llvm" \
    -B "${srcdir}/build-${MSYSTEM}-train"
  rm "${srcdir}/build-${MSYSTEM}-instrument/profiles/"*.profraw || true
  "${MINGW_PREFIX}/bin/cmake" --build "${srcdir}/build-${MSYSTEM}-train" --target clangSema
  "${MINGW_PREFIX}/bin/llvm-profdata" merge -output="${srcdir}/profdata" "${srcdir}/build-${MSYSTEM}-instrument/profiles/"*.profraw
  MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
  "${MINGW_PREFIX}/bin/cmake" \
    -DCMAKE_SYSROOT="${MINGW_PREFIX}" \
    -DCLANG_LINKS_TO_CREATE="clang++;clang-cpp;as;c++;cc;cpp;${MINGW_CHOST}-cc;${MINGW_CHOST}-c++;${MINGW_CHOST}-clang;${MINGW_CHOST}-clang++" \
    -DCOMPILER_RT_EXCLUDE_ATOMIC_BUILTIN=OFF \
    -DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON \
    -DLIBCLANG_BUILD_STATIC=ON \
    -DLLD_DEFAULT_LD_LLD_IS_MINGW=ON \
    -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld" \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_ENABLE_RUNTIMES="compiler-rt" \
    -DLLVM_INSTALL_BINUTILS_SYMLINKS=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_PROFDATA_FILE="${srcdir}/profdata" \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    "${_common_config[@]}" \
    -S "${srcdir}/llvm" \
    -B "${srcdir}/build-${MSYSTEM}"
  "${MINGW_PREFIX}/bin/cmake" --build "${srcdir}/build-${MSYSTEM}"
}

package_clang() {
  pkgdesc="C language family frontend for LLVM (mingw-w64)"
  url="https://clang.llvm.org/"
  groups=("${MINGW_PACKAGE_PREFIX}-toolchain")
  depends=(
    "${MINGW_PACKAGE_PREFIX}-clang-libs=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-compiler-rt=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-crt"
    "${MINGW_PACKAGE_PREFIX}-headers"
    "${MINGW_PACKAGE_PREFIX}-lld=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-llvm-tools=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-winpthreads"
  )
  provides=("${MINGW_PACKAGE_PREFIX}-cc")

  sed -i.orig '/\(extra\|scan-build\|scan-build-py\|scan-view\)\/cmake_install.cmake/d' "${srcdir}/build-${MSYSTEM}/tools/clang/tools/cmake_install.cmake"
  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/tools/clang"
  mkdir -p "${srcdir}/clang-libs/${MINGW_PREFIX}/bin"
  mv -f "${pkgdir}${MINGW_PREFIX}/bin/"libclang{,-cpp}.dll "${srcdir}/clang-libs/${MINGW_PREFIX}/bin/"
}

package_clang-libs() {
  pkgdesc="Clang runtime libraries (mingw-w64)"
  url="https://clang.llvm.org/"
  depends=(
    "${MINGW_PACKAGE_PREFIX}-cc-libs"
    "${MINGW_PACKAGE_PREFIX}-llvm-libs=${pkgver}"
  )

  cp -r "${srcdir}/clang-libs/${MINGW_PREFIX}" "${pkgdir}${MINGW_PREFIX}"
}

package_clang-analyzer() {
  pkgdesc="A source code analysis framework (mingw-w64)"
  url="https://clang-analyzer.llvm.org/"
  depends=("${MINGW_PACKAGE_PREFIX}-clang=${pkgver}")

  for analyzer in scan-build scan-build-py scan-view; do
    DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/tools/clang/tools/${analyzer}"
  done
}

package_clang-tools-extra() {
  pkgdesc="Extra tools built using Clang's tooling APIs (mingw-w64)"
  url="https://clang.llvm.org/"
  depends=("${MINGW_PACKAGE_PREFIX}-clang=${pkgver}")

  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/tools/clang/tools/extra"
}

package_compiler-rt() {
  pkgdesc="Runtime libraries for Clang and LLVM (mingw-w64)"
  url="https://compiler-rt.llvm.org/"

  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/runtimes"
  mkdir -p "${pkgdir}${MINGW_PREFIX}/bin/"
  find "${pkgdir}${MINGW_PREFIX}/lib/clang/${pkgver%.[0-9].*}/lib/windows/" \
    -name "*.dll" -exec mv '{}' "${pkgdir}${MINGW_PREFIX}/bin/" \;
  rmdir "${pkgdir}${MINGW_PREFIX}/bin/" 2>/dev/null || true
}

package_lld() {
  pkgdesc="Linker tools for LLVM (mingw-w64)"
  url="https://lld.llvm.org/"
  groups=("${MINGW_PACKAGE_PREFIX}-toolchain")
  depends=(
    "${MINGW_PACKAGE_PREFIX}-cc-libs"
    "${MINGW_PACKAGE_PREFIX}-llvm-libs=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-zlib"
    "${MINGW_PACKAGE_PREFIX}-zstd"
  )
  provides=("${MINGW_PACKAGE_PREFIX}-binutils")

  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/tools/lld"
  install -Dm755 "${pkgdir}${MINGW_PREFIX}/bin/lld.exe" "${pkgdir}${MINGW_PREFIX}/bin/ld.exe"
}

package_llvm() {
  pkgdesc="Low Level Virtual Machine (mingw-w64)"
  depends=(
    "${MINGW_PACKAGE_PREFIX}-llvm-libs=${pkgver}"
    "${MINGW_PACKAGE_PREFIX}-llvm-tools=${pkgver}"
  )

  sed -i.orig '/tools\/cmake_install.cmake/d' "${srcdir}/build-${MSYSTEM}/cmake_install.cmake"
  sed -i.orig '/compiler-rt\/cmake_install.cmake/d' "${srcdir}/build-${MSYSTEM}/projects/cmake_install.cmake"
  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}"
  install -d "${pkgdir}${MINGW_PREFIX}/share/llvm/cmake/"{modules,platforms}
  install -Dm644 "${srcdir}/llvm/cmake/modules/"*.cmake "${pkgdir}${MINGW_PREFIX}/share/llvm/cmake/modules/"
  install -Dm644 "${srcdir}/llvm/cmake/platforms/"*.cmake "${pkgdir}${MINGW_PREFIX}/share/llvm/cmake/platforms/"
  sed -e "s|$(cygpath -wm "${MINGW_PREFIX}")|${MINGW_PREFIX}|g" -i "${pkgdir}/${MINGW_PREFIX}/lib/cmake/llvm/LLVMExports.cmake"
}

package_llvm-tools() {
  pkgdesc="Low Level Virtual Machine - Tools (mingw-w64)"
  depends=("${MINGW_PACKAGE_PREFIX}-llvm-libs=${pkgver}")

  sed -i.orig '/\(clang\|lld\)\/cmake_install.cmake/d' "${srcdir}/build-${MSYSTEM}/tools/cmake_install.cmake"
  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake" --install "${srcdir}/build-${MSYSTEM}/tools"
  mkdir -p "${srcdir}/llvm-libs/${MINGW_PREFIX}/bin"
  mv -f "${pkgdir}${MINGW_PREFIX}/bin/"lib{LLVM-*,LTO,Remarks}.dll "${srcdir}/llvm-libs/${MINGW_PREFIX}/bin/"
  rm -r "${pkgdir}${MINGW_PREFIX}/include/llvm-c"
  cp "${pkgdir}${MINGW_PREFIX}/bin/llvm-cov.exe" "${pkgdir}${MINGW_PREFIX}/bin/gcov.exe"
}

package_llvm-libs() {
  pkgdesc="Low Level Virtual Machine Runtime Libraries (mingw-w64)"
  depends=(
    "${MINGW_PACKAGE_PREFIX}-cc-libs"
    "${MINGW_PACKAGE_PREFIX}-libffi"
    "${MINGW_PACKAGE_PREFIX}-libxml2"
    "${MINGW_PACKAGE_PREFIX}-zlib"
    "${MINGW_PACKAGE_PREFIX}-zstd"
  )

  cp -r "${srcdir}/llvm-libs/${MINGW_PREFIX}" "${pkgdir}${MINGW_PREFIX}"
}

# template start; name=mingw-w64-splitpkg-wrappers; version=1.0;
# vim: set ft=bash :

# generate wrappers
for _name in "${pkgname[@]}"; do
  _short="package_${_name#${MINGW_PACKAGE_PREFIX}-}"
  _func="$(declare -f "${_short}")"
  eval "${_func/#${_short}/package_${_name}}"
done
# template end;
